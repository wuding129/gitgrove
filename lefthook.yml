# Gitè§„èŒƒåŒ–å·¥ä½œæµé…ç½®
# åˆ†æ”¯åˆ›å»ºçº¦æŸå’Œæäº¤è§„èŒƒéªŒè¯

# åˆ†æ”¯æ¨é€å‰çš„éªŒè¯ - ç”¨äºæ‹¦æˆªä¸è§„èŒƒåˆ†æ”¯
pre-push:
  commands:
    branch-name-check:
      run: |
        # è·å–å½“å‰åˆ†æ”¯å
        current_branch=$(git branch --show-current)
        
        # è·³è¿‡master/mainåˆ†æ”¯çš„æ£€æŸ¥
        if [[ $current_branch == "master" || $current_branch == "main" ]]; then
          exit 0
        fi
        
        # åˆ†æ”¯å‘½åè§„èŒƒæ ¡éªŒ
        if ! [[ $current_branch =~ ^(feature|hotfix|bugfix)_ ]]; then
          echo "âŒ é”™è¯¯: åˆ†æ”¯å '$current_branch' ä¸ç¬¦åˆè§„èŒƒ!"
          echo "ğŸ“‹ æ­£ç¡®æ ¼å¼:"
          echo "   ğŸ”¹ feature_[æ¨¡å—]_[æè¿°] (ä¾‹: feature_user_login)"
          echo "   ğŸ”¹ hotfix_v[ç‰ˆæœ¬]_[æè¿°] (ä¾‹: hotfix_v1.0.3_login_fix)"
          echo "   ğŸ”¹ bugfix_[æè¿°] (ä¾‹: bugfix_scroll_error)"
          echo ""
          echo "ğŸ’¡ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹åˆ†æ”¯åˆ›å»ºå¸®åŠ©:"
          echo "   npm run branch:feature"
          echo "   npm run branch:hotfix"
          echo "   npm run branch:bugfix"
          exit 1
        fi
        
        # ç±»å‹ç‰¹å®šæ ¼å¼éªŒè¯
        if [[ $current_branch =~ ^feature_ ]]; then
          if ! [[ $current_branch =~ ^feature_[a-z0-9]+_[a-z0-9_]+$ ]]; then
            echo "âŒ åŠŸèƒ½åˆ†æ”¯æ ¼å¼é”™è¯¯!"
            echo "ğŸ“‹ æ­£ç¡®æ ¼å¼: feature_[æ¨¡å—]_[æè¿°]"
            echo "ğŸ“ ç¤ºä¾‹: feature_user_login, feature_payment_integration"
            exit 1
          fi
        elif [[ $current_branch =~ ^hotfix_ ]]; then
          if ! [[ $current_branch =~ ^hotfix_v?[0-9.]+_[a-z0-9_]+$ ]]; then
            echo "âŒ çƒ­ä¿®å¤åˆ†æ”¯æ ¼å¼é”™è¯¯!"
            echo "ğŸ“‹ æ­£ç¡®æ ¼å¼: hotfix_v[ç‰ˆæœ¬]_[æè¿°]"
            echo "ğŸ“ ç¤ºä¾‹: hotfix_v1.0.3_login_fix, hotfix_v2.1.0_security_patch"
            exit 1
          fi
        elif [[ $current_branch =~ ^bugfix_ ]]; then
          if ! [[ $current_branch =~ ^bugfix_[a-z0-9_]+$ ]]; then
            echo "âŒ é—®é¢˜ä¿®å¤åˆ†æ”¯æ ¼å¼é”™è¯¯!"
            echo "ğŸ“‹ æ­£ç¡®æ ¼å¼: bugfix_[æè¿°]"
            echo "ğŸ“ ç¤ºä¾‹: bugfix_scroll_error, bugfix_memory_leak"
            exit 1
          fi
        fi
        
        echo "âœ… åˆ†æ”¯åç§°ç¬¦åˆè§„èŒƒ: $current_branch"

# æäº¤ä¿¡æ¯éªŒè¯
commit-msg:
  commands:
    commitlint:
      run: npx --no-install commitlint --edit {1}
      stage_fixed: true

# æäº¤å‰çš„ä»£ç æ£€æŸ¥
pre-commit:
  commands:
    # é˜²æ­¢ç›´æ¥æäº¤åˆ°masteråˆ†æ”¯
    protect-master:
      run: |
        branch=$(git branch --show-current)
        if [[ $branch == "master" || $branch == "main" ]]; then
          echo "âŒ é”™è¯¯: ç¦æ­¢ç›´æ¥å‘ $branch åˆ†æ”¯æäº¤!"
          echo "ğŸ“‹ æ­£ç¡®æµç¨‹:"
          echo "   1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯: git checkout -b feature_[æ¨¡å—]_[æè¿°]"
          echo "   2. åœ¨åŠŸèƒ½åˆ†æ”¯ä¸Šå¼€å‘å’Œæäº¤"
          echo "   3. é€šè¿‡Pull Requeståˆå¹¶åˆ°ä¸»åˆ†æ”¯"
          exit 1
        fi
        
    # ä»£ç è´¨é‡æ£€æŸ¥
    lint-staged:
      glob: "*.{js,ts,vue,jsx,tsx}"
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ ESLintç­‰ä»£ç æ£€æŸ¥å·¥å…·
        # npx eslint {staged_files} --fix
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
